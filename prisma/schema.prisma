// This is your Prisma schema file for PostgreSQL
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String?
  name         String?      // User's display name
  avatar       String?      // Profile picture URL
  bio          String?      // User bio
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relationships
  memberships  Membership[]
  accounts     Account[]
  sessions     Session[]
  
  // User interactions
  likes       Like[]
  shares      Share[]
  subscriptions Subscription[]
  readingList ReadingListItem[]
  purchases    Purchase[]
  
  @@map("users")
}

model Creator {
  id                        String   @id @default(cuid())
  slug                      String   @unique
  name                      String
  storeDomain              String?
  encryptedPublicaApiToken String?
  branding                 Json?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  
  // Relationships
  articles                 Article[]
  memberships              Membership[]
  subscribers              Subscription[]
  
  // Note: Pricing fields removed to match production database schema
  // subscriptionPrice        Int?     // Monthly subscription price in cents  
  // subscriptionPriceId     String?   // Stripe price ID for subscription
  // defaultArticlePrice     Int?     // Default price for articles in cents
  
  @@map("creators")
}

model Membership {
  id         String   @id @default(cuid())
  userId     String
  creatorId  String
  role       String   // "owner", "editor", "subscriber"
  createdAt  DateTime @default(now())
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  @@unique([userId, creatorId])
  @@map("memberships")
}

model Article {
  id                String   @id @default(cuid())
  title             String
  slug              String
  coverUrl          String?
  tags              String? // Comma-separated tags
  bodyMarkdown      String?
  contentType       String   @default("text")
  status            String   @default("draft")
  visibility        String   @default("paid") // "free", "paid", "subscribers"
  price             Int?     // Price in cents for individual purchase
  priceId           String?  // Stripe price ID for this article
  pricing           Json?    // JSON pricing object
  audioUrl          String?  // URL for audio content
  imageUrls         Json?    // Array of image URLs
  videoUrl          String?  // URL for video content
  videoId           String?  // Video ID for video content
  creatorId         String
  publishedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relationships
  creator           Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  currentArtifact   Artifact? @relation("CurrentArtifact", fields: [currentArtifactId], references: [id])
  currentArtifactId String? @unique
  artifacts         Artifact[]
  likes             Like[]
  shares            Share[]
  readingList       ReadingListItem[]
  purchases         Purchase[]
  
  @@unique([creatorId, slug])
  @@map("articles")
}

model Artifact {
  id               String   @id @default(cuid())
  articleId        String
  version          Int
  theme            String?
  epubUrl          String?
  pdfUrl           String?
  storageProvider  String?  // local | s3 | r2
  publicaIssueId   String?
  publicaExternalId String?
  buildLog         Json? // JSON object for PostgreSQL
  createdAt        DateTime @default(now())

  article          Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  // back-reference for currentArtifact relation
  articleAsCurrent  Article? @relation("CurrentArtifact")

  @@unique([articleId, version])
  @@map("artifacts")
}

// NextAuth.js required models
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id            String   @id @default(cuid())
  sessionToken  String   @unique
  userId        String
  expires       DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// New models for user interactions
model Like {
  id         String   @id @default(cuid())
  userId     String
  articleId  String
  createdAt  DateTime @default(now())
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, articleId])
  @@map("likes")
}

model Share {
  id         String   @id @default(cuid())
  userId     String
  articleId  String
  platform   String?  // "twitter", "facebook", "linkedin", "copy"
  createdAt  DateTime @default(now())
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  @@map("shares")
}

model Subscription {
  id         String   @id @default(cuid())
  userId     String
  creatorId  String
  status     String   @default("active")
  plan       String?
  stripeSubscriptionId String? // Stripe subscription ID
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  expiresAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  @@unique([userId, creatorId])
  @@map("subscriptions")
}

model ReadingListItem {
  id         String   @id @default(cuid())
  userId     String
  articleId  String
  addedAt    DateTime @default(now())
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, articleId])
  @@map("reading_list")
}

// New models for payments and access
model Purchase {
  id          String   @id @default(cuid())
  userId      String
  articleId   String
  amount      Int      // Amount paid in cents
  currency    String   @default("usd")
  stripePaymentIntentId String?
  status      String   @default("pending") // "pending", "completed", "failed"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, articleId])
  @@map("purchases")
}
